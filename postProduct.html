<!DOCTYPE html>
<html>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=, initial-scale=1.0">
        <link rel="webside icon" type="png" href="/img/icon/icon.jpg">
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <link rel="stylesheet" type="text/css" href="css/postProduct.css">
        <link rel="stylesheet" type="text/css" href="css/head-footer.css">
        <title>Flea Shop</title>
    </head>
    <script>
      var isLoggedIn = sessionStorage.getItem('isLoggedIn');
      if(isLoggedIn == null) {
        const loginPageUrl = 'login.html';
        window.location.href = loginPageUrl;
      }
    </script>
    <body>
      <script src="js/Campus.js"></script>
      <script src="js/Category.js"></script>
        <div class="header">
            <a class="title" href="homepage.html">Flea Shop</a>
           </div>
        <div class="container">
            <div class="post">
                <h1>ĐĂNG TIN</h1>
                <form onsubmit="event.preventDefault(); uploadAndCreatePost(event)">
                  <div class="content-1">
                    <select id="optionCategory" style="font-family: 'Courier New', Courier, monospace">

                    </select>
                    <input type="text" name="name" placeholder="Tên sản phẩm">
                    <input type="text" name="discriptions" placeholder="Mô tả sản phẩm" style="height: 120px;">
                    <select id="listCampuses" style="font-family: 'Courier New', Courier, monospace">

                    </select>
                    <input type="text" name="price" placeholder="Giá">
                  </div>
                <div class="content-2">
                  <label for="photo" >
                    <img src="img/icon/uploadimg.png" id="profile-pic" style="width: 350px; height: 350px; margin: -45px 0px 0px -30px;">
                  </label> 
                </div>      
               
                 
                  <input type="submit" name="submit" value="Tạo" class="button"/>
                  
               
                 <a href="postProduct.html" class="button">
                  <span class="button-text">
                     Hủy
                   </span>
                 </a>         
            </form>
            </div>
        </div>
        <div>
                  <input type="file" accept="image/jpeg, image/png, image/jpg" id="photo" style="background-color: rgb(253, 253, 253); border: none; display: none;">
                <button onclick="uploadImage()" id="uploadBtn" style="display: none;"></button>
                <label></label>
        </div>
        <div id="errorMessage" class="errorMessage"></div>
        <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
          <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
          <script>
              // Import the functions you need from the SDKs you need
  
              // TODO: Add SDKs for Firebase products that you want to use
              // https://firebase.google.com/docs/web/setup#available-libraries
  
              // Your web app's Firebase configuration
          
              let profilePic = document.getElementById("profile-pic");
              let photo = document.getElementById("photo");
              photo.onchange = function(){
                profilePic.src = URL.createObjectURL(photo.files[0]);
              }

              const firebaseConfig = {
                apiKey: "AIzaSyCCvDizeCUo-CZIdI-G57gR9jyTS9rh-3w",
                authDomain: "image-9930d.firebaseapp.com",
                projectId: "image-9930d",
                storageBucket: "image-9930d.appspot.com",
                messagingSenderId: "1022991899193",
                appId: "1:1022991899193:web:75020005a28e274b95cbe8"
              };
  
              // Initialize Firebase
              const firebaseApp = firebase.initializeApp(firebaseConfig);
  
            </script>
            <script>
            // Khai báo biến product ở ngoài hàm uploadAndCreatePost
            let product = {};
            
            function uploadAndCreatePost(event) {
              event.preventDefault(); // Ngăn chặn hành vi mặc định của submit
            
              // Tạo đối tượng Date để lấy ngày tháng năm và thời gian hiện tại
              const currentDate = new Date();
            
              // Lấy thông tin ngày, tháng, năm và thời gian hiện tại
              const day = currentDate.getDate();
              const month = currentDate.getMonth() + 1; // Tháng trong JavaScript bắt đầu từ 0, nên cần cộng thêm 1
              const year = currentDate.getFullYear();
              const hours = currentDate.getHours();
              const minutes = currentDate.getMinutes();
              const seconds = currentDate.getSeconds();
            
              // Tạo chuỗi đại diện cho ngày tháng năm và thời gian hiện tại
              const createAT = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
              const createATDate = new Date(createAT);
              const expireDate = new Date(createATDate);
              expireDate.setDate(createATDate.getDate() + 20);
              const dayexpire = expireDate.getDate();
              const monthexpire = expireDate.getMonth() + 1;
              const yearexpire = expireDate.getFullYear();
              const expire = `${yearexpire}-${String(monthexpire).padStart(2, '0')}-${String(dayexpire).padStart(2, '0')} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

              const listCategory = document.getElementById("optionCategory");
              const selectedCategoryId = listCategory.value;
            
              const listCampuses = document.getElementById("listCampuses");
                const selectedCampusId = listCampuses.value;
            
              const name = document.querySelector('input[name="name"]').value;
              const description = document.querySelector('input[name="discriptions"]').value;
              const price = parseInt(document.querySelector('input[name="price"]').value);
              const seller_id = parseInt(sessionStorage.getItem('id'));
            
              product = {
                name: name,
                description: description,
                price: price,
                image: '', // Giá trị ban đầu của thuộc tính "image"
                createAT: createAT,
                expire: expire,
                quantity: 1,
                seller_id: seller_id,
                sellcampusid: parseInt(selectedCampusId),
                categoryid: parseInt(selectedCategoryId),
                status: 'Chờ duyệt'
              };
            
              const ref = firebaseApp.storage().ref();
              const file = document.querySelector('#photo').files[0];
              const metadata = {
                contentType: file.type
              };
              const nameimg = file.name;
              const uploadTask = ref.child(nameimg).put(file, metadata);
              uploadTask
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                  product.image = url;
                  createNewProduct(product);
                  console.log(JSON.stringify(product, null, 2));
                })
                .catch(console.error);
            }
            
            function createNewProduct(product) {
              fetch("http://localhost:8080/product/createNewProduct", {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(product)
              })
                .then(response => {
                  if (response.ok) {
                    console.log('Tạo sản phẩm thành công');
                    window.location.href = 'sales.html';
                    // Thực hiện các hành động bổ sung sau khi tạo sản phẩm thành công
                  } else {
                    errorMessage.textContent = "Không thể thực hiện. Vui lòng kiểm tra lại số dư";
                    console.error('Lỗi tạo sản phẩm');
                  }
                })
                .catch(error => {
                  console.error('Lỗi tạo sản phẩm', error);
                });
            }
          </script>
    </body>
    <footer>
      <div class="container-fluid footer">
        Address: Lot E2a-7, Road D1, D. D1, Long Thanh My, Thu Duc City, Ho Chi Minh City<br/>
        Contact us: fleashop@gmail.com
      </div>
      </footer>
</html>