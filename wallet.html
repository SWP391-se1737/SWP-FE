<html>
    <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1.0">
  <link rel="webside icon" type="png" href="/img/icon/icon.jpg">
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <!-- fontawesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <!-- Css -->
  <link rel="stylesheet" href="css/head-footer.css">
  <link rel="stylesheet" href="css/homepage.css">
  <link rel="stylesheet" href="css/wallet.css">
  <title>Flea Shop</title>
</head>
<script>
  var isLoggedIn = sessionStorage.getItem('isLoggedIn');
      if(isLoggedIn == null) {
        const loginPageUrl = 'login.html';
        window.location.href = loginPageUrl;
      }
</script>
<body>
     <!-- navbar -->
  <nav class="navbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="homepage.html">Flea Shop</a>
      <form class="d-flex" role="search">    
        <input id="searchbar" onkeyup="search_animal()"  name="search" class="form-control me-2" type="search" placeholder="Tìm sản phẩm" aria-label="Search">
        <a href="searchproduct.html" class="btn"><i class="fa-solid fa-magnifying-glass"></i></a>
        <!-- <a href="shopping-cart.html" class="ping"><i class="fa-solid fa-cart-shopping"></i><span
            class="qtycart">0</span></a> -->
      </form>
      <a href="postProduct.html" class="button">
       <span class="button-text" style="font-family: 'Courier New', Courier, monospace; font-weight: bold;">
          Đăng tin
        </span>
        <a href="#" class="ping" id="menuTrigger"><i class="fas fa-user"></i></a>
        <div id="sidebar">
          <ul>
            <li id="loginItem"><a href="login.html">Đăng nhập</a></li>
            <li id="profileItem"><a href="profile.html">Thông tin cá nhân</a></li>
            <li id="walletItem"><a href="wallet.html">Ví</a></li>
            <li id="ordersItem"><a href="orders.html">Đơn đã mua</a></li>
            <li id="salesItem"><a href="sales.html">Đơn đã bán</a></li>
            <li id="transactionsItem"><a href="transactions.html">Giao dịch đã thực hiện</a></li>
            <li id="logoutItem" style="display: none;"><a href="#" onclick="logout(); return false;">Đăng xuất</a></li>
          </ul>
        </div>

        <script>
          // Lấy phần tử nút trigger và phần tử menu dọc
          const menuTrigger = document.getElementById("menuTrigger");
          const sidebar = document.getElementById("sidebar");
          var isLoggedIn = sessionStorage.getItem('isLoggedIn');
          var accid = sessionStorage.getItem('id');

          // Xác định trạng thái menu (ẩn/hiển thị)
          let isSidebarOpen = false;

          // Xử lý sự kiện nhấp chuột vào nút trigger
          menuTrigger.addEventListener("click", function (e) {
            e.preventDefault();

            // Đảo ngược trạng thái menu và cập nhật giao diện
            isSidebarOpen = !isSidebarOpen;
            if (isSidebarOpen) {
              sidebar.classList.add("open"); // Thêm lớp "open" để hiển thị sidebar
              if (isLoggedIn === "true") {
                // Đã đăng nhập
                document.getElementById("loginItem").style.display = "none";
                document.getElementById("profileItem").style.display = "block";
                document.getElementById("walletItem").style.display = "block";
                document.getElementById("ordersItem").style.display = "block";
                document.getElementById("salesItem").style.display = "block";
                document.getElementById("transactionsItem").style.display = "block";
                document.getElementById("logoutItem").style.display = "block";
              } else {
                // Chưa đăng nhập
                document.getElementById("loginItem").style.display = "block";
                document.getElementById("profileItem").style.display = "none";
                document.getElementById("walletItem").style.display = "none";
                document.getElementById("ordersItem").style.display = "none";
                document.getElementById("salesItem").style.display = "none";
                document.getElementById("transactionsItem").style.display = "none";
                document.getElementById("logoutItem").style.display = "none";
              }
            } else {
              sidebar.classList.remove("open"); // Xóa lớp "open" để ẩn sidebar
            }
          });

          function logout() {
          // Xóa các mục trong sessionStorage
          sessionStorage.removeItem('isLoggedIn');
          sessionStorage.removeItem('id');

          // Điều hướng về trang homepage.html
          window.location.href = 'homepage.html';
          }
        </script>
    </div>
</nav>
<h1 class="namepage">SỐ DƯ VÍ</h1>
<div id="balanceContainer" class="price"></div>
<div class="wallet">Nạp đồng vào ví</div>
<section class="container">
  <div class="imgage">
    <a href="#" class="paymentLink" data-amount="100000" onclick="displayPaymentButton(50000, this, 'wallet.html')">
      <img src="https://cdn.discordapp.com/attachments/961630510084395009/1128803641327878144/image.png" alt="Gói 52 Xu" fetchpriority="high" loading="lazy">
    </a>
    <a href="#" class="paymentLink" data-amount="200000" onclick="displayPaymentButton(100000, this, 'wallet.html')">
      <img src="https://cdn.discordapp.com/attachments/961630510084395009/1128804144539516948/image.png" alt="Gói 52 Xu" fetchpriority="high" loading="lazy">
    </a>
    <a href="#" class="paymentLink" data-amount="300000" onclick="displayPaymentButton(150000, this, 'wallet.html')">
      <img src="https://cdn.discordapp.com/attachments/961630510084395009/1128804468041977927/image.png" alt="Gói 52 Xu" fetchpriority="high" loading="lazy">
    </a>
    <a href="#" class="paymentLink" data-amount="400000" onclick="displayPaymentButton(200000, this, 'wallet.html')">
      <img src="https://cdn.discordapp.com/attachments/961630510084395009/1128804594655432764/image.png" alt="Gói 52 Xu" fetchpriority="high" loading="lazy">
    </a>
  </div>
  <div id="paymentButtonContainer" class="payment">
    <!-- Nút thanh toán -->
  </div>
  
</section>
<script>
  // Gọi API để nhận số dư từ backend
  function getBalance() {
    // Thực hiện AJAX request đến endpoint /getWalletBalanceByUserId/{userId} với userId tương ứng
    var accid = sessionStorage.getItem('id');
    var url = "http://localhost:8080/wallet/getWalletBalanceByUserId/" + accid;

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        // Phản hồi thành công từ API
        var balanceList = JSON.parse(xhr.responseText);

        // Lấy số dư đầu tiên trong danh sách (giả sử chỉ có một số dư duy nhất)
        var balance = balanceList[0];

        // Hiển thị số dư trong phần tử <div>
        var balanceContainer = document.getElementById("balanceContainer");
        balanceContainer.innerHTML = balance;
      }
    };
    xhr.send();
  }

  // Gọi hàm getBalance để hiển thị số dư khi trang được tải
  getBalance();
</script>
<script>
  var accid = sessionStorage.getItem('id');

  function displayPaymentButton(amount, element, returnUrl) {
    // Xóa các nút thanh toán hiện có
    var paymentContainer = document.getElementById("paymentButtonContainer");
    while (paymentContainer.firstChild) {
      paymentContainer.firstChild.remove();
    }

    // Tạo nút thanh toán và chuyển hướng khi được nhấp
    var paymentButton = document.createElement("button");
    paymentButton.innerHTML = "Xác nhận thanh toán ";
    paymentButton.onclick = function() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            var response = JSON.parse(xhr.responseText);
            var paymentLink = response.url;
            window.location.href = paymentLink;
          } else {
            console.error("Lỗi khi gọi API: " + xhr.status);
          }
          
        }
      };
      xhr.open("GET", "http://localhost:8080/wallet/getWalletBalanceByUserId/" + accid, true);
      xhr.send();
    };

    // Sao chép hình ảnh từ tấm hình và thêm vào nút thanh toán
    var image = element.querySelector("img");
    var imageCopy = image.cloneNode(true);
    paymentButton.appendChild(imageCopy);

    paymentContainer.appendChild(paymentButton);

    // Gọi API để lấy balance
    paymentButton.onclick = function() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    var paymentLink = response.url;
                    // Redirect to the payment link
                    window.location.href = paymentLink;
                } else {
                    console.error("Lỗi khi gọi API: " + xhr.status);
                }
            }
        };
        xhr.open("GET", "http://localhost:8080/payment/createPayment?id=" + accid + "&amount=" + amount, true);
        xhr.send();
        
    };
    var accid = sessionStorage.getItem('id');
    var exchangprovider = "vnpay";
var url = "http://localhost:8080/Deposits/addDeposits";

var data = {
  currency_from: amount,
  currency_to: amount/1000,
  user_id: parseInt(sessionStorage.getItem('id')),
  exchangeProvider: exchangprovider
};
console.log(data);
var xhr = new XMLHttpRequest();
xhr.open("POST", url, true);
xhr.setRequestHeader("Content-Type", "application/json");

xhr.onreadystatechange = function() {
  if (xhr.readyState === 4 && xhr.status === 200) {
    // Xử lý phản hồi thành công từ server (nếu cần)
    console.log(xhr.responseText);
  }
};

xhr.send(JSON.stringify(data));
 
  }

</script>

<script src="js/Sales.js"></script>

</body>
<footer style="position: absolute">
  <div class="container-fluid footer">
    Address: Lot E2a-7, Road D1, D. D1, Long Thanh My, Thu Duc City, Ho Chi Minh City<br/>
    Contact us: fleashop@gmail.com
  </div>
  </footer>
 </html>